import os
import asyncio
import sqlite3
import hashlib
import glob
import tkinter as tk
from tkinter import ttk, messagebox, filedialog, simpledialog
import base64
from io import BytesIO
import numpy as np
from PIL import Image, ImageTk
from colorama import Fore, Style
from matplotlib import pyplot as plt
from zhipuai import ZhipuAI
import threading
import platform
import subprocess
import datetime
import re
import random
import shutil

# ===== å¸¸é‡ä¸é…ç½® =====
_API_KEYS = {
    "GLM": ""
}


# ===== å·¥å…·å‡½æ•° =====
def get_api_key(service):
    """è·å–APIå¯†é’¥ - ä¼˜å…ˆä½¿ç”¨ç¡¬ç¼–ç å¯†é’¥"""
    service = service.upper()
    if service in _API_KEYS:
        return _API_KEYS[service]
    return os.getenv(f"{service}_API_KEY") or None


def log_info(msg):
    print(f"{Fore.GREEN}ğŸŒ¸ {msg}{Style.RESET_ALL}")


def log_warning(msg):
    print(f"{Fore.YELLOW}âš ï¸ {msg}{Style.RESET_ALL}")


def log_error(msg):
    print(f"{Fore.RED}ğŸ’¥ {msg}{Style.RESET_ALL}")


def hash_password(password):
    """å¯†ç å“ˆå¸Œå¤„ç†"""
    return hashlib.sha256(password.encode()).hexdigest()


def clear_folder(folder_path):
    """æ¸…ç©ºæŒ‡å®šæ–‡ä»¶å¤¹"""
    files = glob.glob(os.path.join(folder_path, "*"))
    for file in files:
        try:
            os.remove(file)
            print(f"âœ¨ å·²åˆ é™¤: {file}")
        except Exception as e:
            print(f"ğŸ˜¢ åˆ é™¤å¤±è´¥: {file}, åŸå› : {e}")


def merge_md_files():
    """åˆå¹¶Markdownæ–‡ä»¶"""
    md_files = glob.glob(os.path.join("output", "*.md"))
    if not md_files:
        print("ğŸ˜® æ²¡æœ‰æ‰¾åˆ°å¯åˆå¹¶çš„mdæ–‡ä»¶~")
        return False

    # æŒ‰æ–‡ä»¶åæ’åº
    sorted_files = sorted(md_files, key=lambda x: os.path.basename(x))
    merged_content = ""

    for file in sorted_files:
        try:
            with open(file, 'r', encoding='utf-8') as f:
                content = f.read()
                merged_content += content + "\n\n"
                print(f"âœ… å·²åˆå¹¶: {os.path.basename(file)}")
        except Exception as e:
            print(f"ğŸ˜¢ è¯»å–å¤±è´¥: {file}, åŸå› : {e}")

    try:
        with open(os.path.join("output", "all.md"), 'w', encoding='utf-8') as f:
            f.write(merged_content)
        print("ğŸ‰ åˆå¹¶å®Œæˆ! å·²åˆ›å»º all.md")
        return True
    except Exception as e:
        print(f"ğŸ˜¢ åˆ›å»ºåˆå¹¶æ–‡ä»¶å¤±è´¥: {e}")
        return False


# ===== æ ¸å¿ƒAPIåŠŸèƒ½ =====
async def image_to_markdown(image_path):
    """å°†å›¾ç‰‡è½¬æ¢ä¸ºMarkdownæ ¼å¼"""
    try:
        api_key = get_api_key("GLM")
        if not api_key:
            log_error("GLM APIå¯†é’¥ä¸å¯æç®€")
            return None

        if not os.path.exists(image_path):
            log_error(f"å›¾ç‰‡æ–‡ä»¶ä¸å­˜åœ¨: {image_path}")
            return None

        if not image_path.lower().endswith(('.png', '.jpg', '.jpeg')):
            log_error(f"ä¸æ”¯æŒçš„æ–‡ä»¶ç±»å‹: {image_path}")
            return None

        with Image.open(image_path) as img:
            if img.mode != 'RGB':
                img = img.convert('RGB')

            buffer = BytesIO()
            img.save(buffer, format="JPEG")
            img_base64 = base64.b64encode(buffer.getvalue()).decode("utf-8")

        client = ZhipuAI(api_key=api_key)

        response = client.chat.completions.create(
            model="glm-4v-flash",
            messages=[{
                "role": "user",
                "content": [
                    {"type": "image_url", "image_url": {"url": f"data:image/jpeg;base64,{img_base64}"}},
                    {"type": "text", "text": "è¯·å°†å›¾ç‰‡å†…å®¹è½¬å†™ä¸ºMarkdownæ ¼å¼"}
                ]
            }],
            stream=False,
            max_tokens=1024,
            temperature=0.5
        )
        return response.choices[0].message.content.strip()
    except Exception as e:
        log_error(f"å›¾ç‰‡å¤„ç†å¼‚å¸¸: {str(e)}")
        return None


async def generate_answers(prompt):
    """ç”Ÿæˆé—®é¢˜ç­”æ¡ˆ"""
    try:
        api_key = get_api_key("GLM")
        if not api_key:
            log_error("GLM APIå¯†é’¥ä¸å¯ç”¨")
            return None

        client = ZhipuAI(api_key=api_key)

        if len(prompt) > 2500:
            truncated_prompt = prompt[:2400] + "...[å†…å®¹è¿‡é•¿å·²æˆªæ–­]"
            log_warning(f"æç¤ºè¿‡é•¿å·²æˆªæ–­: {len(prompt)}å­—ç¬¦ â†’ {len(truncated_prompt)}å­—ç¬¦")
            prompt = truncated_prompt

        response = client.chat.completions.create(
            model="glm-4",
            messages=[{"role": "user", "content": prompt}],
            temperature=0.7,
            max_tokens=512,
            stream=False
        )
        return response.choices[0].message.content.strip()
    except Exception as e:
        log_error(f"ç­”æ¡ˆç”Ÿæˆå¼‚å¸¸: {str(e)}")
        return None


# ===== æ•°æ®åº“ç®¡ç† =====
def init_db():
    """åˆå§‹åŒ–ç”¨æˆ·æ•°æ®åº“"""
    conn = sqlite3.connect('user_db.db')
    c = conn.cursor()

    # ç”¨æˆ·è¡¨
    c.execute('''CREATE TABLE IF NOT EXISTS users (
                     id INTEGER PRIMARY KEY AUTOINCREMENT,
                     username TEXT UNIQUE NOT NULL,
                     password TEXT NOT NULL,
                     role TEXT DEFAULT 'student')''')

    # é¢˜ç›®åˆ†äº«è¡¨ - ä¿®å¤ç¼ºå°‘ likes åˆ—çš„é—®é¢˜
    c.execute('''CREATE TABLE IF NOT EXISTS shared_questions (
                     id INTEGER PRIMARY KEY AUTOINCREMENT,
                     user_id INTEGER NOT NULL,
                     title TEXT NOT NULL,
                     content TEXT NOT NULL,
                     tags TEXT,
                     likes INTEGER DEFAULT 0,  
                     created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
                     FOREIGN KEY(user_id) REFERENCES users(id))''')
    try:
        c.execute("SELECT likes FROM shared_questions LIMIT 1")
    except sqlite3.OperationalError:
        # å¦‚æœåˆ—ä¸å­˜åœ¨ï¼Œåˆ™æ·»åŠ 
        c.execute("ALTER TABLE shared_questions ADD COLUMN likes INTEGER DEFAULT 0")
    # è¯„è®ºè¡¨
    c.execute('''CREATE TABLE IF NOT EXISTS comments (
                     id INTEGER PRIMARY KEY AUTOINCREMENT,
                     question_id INTEGER NOT NULL,
                     user_id INTEGER NOT NULL,
                     content TEXT NOT NULL,
                     created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
                     FOREIGN KEY(question_id) REFERENCES shared_questions(id),
                     FOREIGN KEY(user_id) REFERENCES users(id))''')


    conn.commit()
    conn.close()


class ExamHelperApp:
    def __init__(self, root):
        self.root = root
        self.root.title("æ™ºèƒ½æ•°å­¦åŠ©æ‰‹")
        self.root.geometry("800x600")
        self.current_user = None
        self.main_frame = ttk.Frame(self.root)
        self.main_frame.pack(fill=tk.BOTH, expand=True)
        self.photo_img = None
        init_db()
        self.show_login_page()

    def clear_frame(self):
        """æ¸…é™¤å½“å‰æ¡†æ¶ä¸­çš„æ‰€æœ‰ç»„ä»¶"""
        for widget in self.main_frame.winfo_children():
            widget.destroy()
        self.photo_img = None

    # ===== ç”¨æˆ·è®¤è¯åŠŸèƒ½ =====
    def show_login_page(self):
        """æ˜¾ç¤ºç™»å½•é¡µé¢"""
        self.clear_frame()
        ttk.Label(self.main_frame, text="æ™ºèƒ½æ•°å­¦åŠ©æ‰‹", font=("Arial", 20)).pack(pady=30)
        ttk.Button(self.main_frame, text="ç™»å½•", command=self.show_login_form, width=20).pack(pady=10)
        ttk.Button(self.main_frame, text="æ³¨å†Œ", command=self.show_register_form, width=20).pack(pady=10)

    def show_login_form(self):
        """æ˜¾ç¤ºç™»å½•è¡¨å•"""
        self.clear_frame()
        ttk.Label(self.main_frame, text="ç”¨æˆ·ç™»å½•", font=("Arial", 16)).pack(pady=20)

        # ç”¨æˆ·åè¾“å…¥
        ttk.Label(self.main_frame, text="ç”¨æˆ·å:").pack()
        self.login_username = ttk.Entry(self.main_frame, width=30)
        self.login_username.pack(pady=5)

        # å¯†ç è¾“å…¥
        ttk.Label(self.main_frame, text="å¯†ç :").pack()
        self.login_password = ttk.Entry(self.main_frame, show="*", width=30)
        self.login_password.pack(pady=5)

        # æŒ‰é’®åŒºåŸŸ
        btn_frame = ttk.Frame(self.main_frame)
        btn_frame.pack(pady=20)
        ttk.Button(btn_frame, text="ç™»å½•", command=self.login).pack(side=tk.LEFT, padx=10)
        ttk.Button(btn_frame, text="è¿”å›", command=self.show_login_page).pack(side=tk.LEFT, padx=10)

    def show_register_form(self):
        """æ˜¾ç¤ºæ³¨å†Œè¡¨å•"""
        self.clear_frame()
        ttk.Label(self.main_frame, text="ç”¨æˆ·æ³¨å†Œ", font=("Arial", 16)).pack(pady=20)

        # ç”¨æˆ·åè¾“å…¥
        ttk.Label(self.main_frame, text="ç”¨æˆ·å:").pack()
        self.reg_username = ttk.Entry(self.main_frame, width=30)
        self.reg_username.pack(pady=5)

        # å¯†ç è¾“å…¥
        ttk.Label(self.main_frame, text="å¯†ç :").pack()
        self.reg_password = ttk.Entry(self.main_frame, show="*", width=30)
        self.reg_password.pack(pady=5)

        # æŒ‰é’®åŒºåŸŸ
        btn_frame = ttk.Frame(self.main_frame)
        btn_frame.pack(pady=20)
        ttk.Button(btn_frame, text="æ³¨å†Œ", command=self.register).pack(side=tk.LEFT, padx=10)
        ttk.Button(btn_frame, text="å–æ¶ˆ", command=self.show_login_page).pack(side=tk.LEFT, padæç®€=10)

    def login(self):
        """å¤„ç†ç™»å½•é€»è¾‘"""
        username = self.login_username.get()
        password = self.login_password.get()

        if not username or not password:
            messagebox.showerror("é”™è¯¯", "ç”¨æˆ·åå’Œå¯†ç ä¸èƒ½ä¸ºç©º")
            return

        hashed_pwd = hash_password(password)
        try:
            conn = sqlite3.connect('user_db.db')
            c = conn.cursor()
            c.execute("SELECT * FROM users WHERE username=? AND password=?", (username, hashed_pwd))
            user = c.fetchone()

            if user:
                self.current_user = user[0]
                self.show_main_page()
            else:
                messagebox.showerror("é”™è¯¯", "ç”¨æˆ·åæˆ–å¯†ç ä¸æ­£ç¡®")
        except Exception as e:
            messagebox.showerror("é”™è¯¯", f"æ•°æ®åº“é”™è¯¯: {str(e)}")
        finally:
            conn.close()

    def register(self):
        """å¤„ç†æ³¨å†Œé€»è¾‘"""
        username = self.reg_username.get()
        password = self.reg_password.get()

        if not username or not password:
            messagebox.showerror("é”™è¯¯", "ç”¨æˆ·åå’Œå¯†ç ä¸èƒ½ä¸ºç©º")
            return

        if len(password) < 6:
            messagebox.showerror("é”™è¯¯", "å¯†ç é•¿åº¦è‡³å°‘ä¸º6ä½")
            return

        hashed_pwd = hash_password(password)
        try:
            conn = sqlite3.connect('user_db.db')
            c = conn.cursor()
            c.execute("SELECT * FROM users WHERE username=?", (username,))
            if c.fetchone():
                messagebox.showerror("é”™è¯¯", "ç”¨æˆ·åå·²å­˜åœ¨")
                return

            c.execute("INSERT INTO users (username, password) VALUES (?, ?)", (username, hashed_pwd))
            conn.commit()
            messagebox.showinfo("æˆåŠŸ", "æ³¨å†ŒæˆåŠŸï¼")
            self.show_login_page()
        except Exception as e:
            messagebox.showerror("é”™è¯¯", f"æ³¨å†Œå¤±è´¥: {str(e)}")
        finally:
            conn.close()

    def get_username(self):
        """è·å–å½“å‰ç”¨æˆ·å"""
        try:
            conn = sqlite3.connect('user_db.db')
            c = conn.cursor()
            c.execute("SELECT username FROM users WHERE id=?", (self.current_user,))
            return c.fetchone()[0]
        except:
            return "ç”¨æˆ·"

    def logout(self):
        """é€€å‡ºç™»å½•"""
        self.current_user = None
        self.show_login_page()

    # ===== ä¸»é¡µé¢åŠŸèƒ½ =====
    def show_main_page(self):
        """æ˜¾ç¤ºä¸»é¡µé¢"""
        self.clear_frame()
        ttk.Label(self.main_frame, text=f"æ¬¢è¿, {self.get_username()}!", font=("Arial", 16)).pack(pady=20)

        # åŠŸèƒ½æŒ‰é’®
        ttk.Button(self.main_frame, text="é¢˜ç›®åˆ†æ", command=self.show_exercise_page, width=20).pack(pady=10)
        ttk.Button(self.main_frame, text="æ–‡ä»¶ç®¡ç†", command=self.show_file_manager, width=20).pack(pady=10)
        ttk.Button(self.main_frame, text="é¢˜ç›®åˆ†äº«ç¤¾åŒº", command=self.show_community_page, width=20).pack(pady=10)

        # è´¦å·ç®¡ç†åŠŸèƒ½
        ttk.Button(self.main_frame, text="è´¦å·è®¾ç½®", command=self.show_account_settings, width=20).pack(pady=10)
        ttk.Button(self.main_frame, text="é€€å‡ºç™»å½•", command=self.logout, width=20).pack(pady=10)

    # ===== é¢˜ç›®åˆ†æåŠŸèƒ½ =====
    def show_exercise_page(self):
        """æ˜¾ç¤ºé¢˜ç›®åˆ†æé¡µé¢"""
        self.clear_frame()

        # æ·»åŠ é¡¶éƒ¨è¿”å›æŒ‰é’®
        top_frame = ttk.Frame(self.main_frame)
        top_frame.pack(fill=tk.X, padx=10, pady=5)
        ttk.Button(top_frame, text="â† è¿”å›ä¸»é¡µé¢", command=self.show_main_page).pack(side=tk.LEFT)

        ttk.Label(self.main_frame, text="é¢˜ç›®åˆ†æ", font=("Arial", 16)).pack(pady=10)

        # åˆ›å»ºå·¦å³ä¸¤ä¸ªæ¡†æ¶
        left_frame = ttk.Frame(self.main_frame)
        left_frame.pack(side=tk.LEFT, fill=tk.BOTH, expand=True, padx=10, pady=10)

        right_frame = ttk.Frame(self.main_frame)
        right_frame.pack(side=tk.RIGHT, fill=tk.BOTH, expand=True, padx=10, pady=10)

        # å·¦ä¾§ï¼šæ–‡ä»¶é€‰æ‹©å’Œç»“æœåŒºåŸŸ
        self.setup_file_selection(left_frame)
        self.setup_result_area(left_frame)

        # å³ä¾§ï¼šå›¾ç‰‡é¢„è§ˆåŒºåŸŸ
        self.setup_image_preview(right_frame)

    def setup_file_selection(self, parent):
        """è®¾ç½®æ–‡ä»¶é€‰æ‹©åŒºåŸŸ"""
        file_frame = ttk.LabelFrame(parent, text="é€‰æ‹©é¢˜ç›®å›¾ç‰‡")
        file_frame.pack(fill=tk.X, padx=5, pady=5)

        self.file_path = tk.StringVar()
        ttk.Entry(file_frame, textvariable=self.file_path, state="readonly", width=30).pack(
            side=tk.LEFT, padx=5, fill=tk.X, expand=True)
        ttk.Button(file_frame, text="æµè§ˆ...", command=self.select_file).pack(side=tk.LEFT, padx=5)

    def setup_result_area(self, parent):
        """è®¾ç½®ç»“æœåŒºåŸŸ"""
        ttk.Button(parent, text="åˆ†æé”™é¢˜", command=self.analyze_exercise, width=20).pack(pady=10)

        result_frame = ttk.LabelFrame(parent, text="åˆ†æç»“æœ")
        result_frame.pack(fill=tk.BOTH, expand=True, padx=5, pady=5)

        scrollbar = ttk.Scrollbar(result_frame)
        scrollbar.pack(side=tk.RIGHT, fill=tk.Y)

        self.result_text = tk.Text(result_frame, wrap=tk.WORD, yscrollcommand=scrollbar.set)
        self.result_text.pack(fill=tk.BOTH, expand=True)
        scrollbar.config(command=self.result_text.yview)

        # æ·»åŠ åˆ†äº«æŒ‰é’®
        btn_frame = ttk.Frame(parent)
        btn_frame.pack(pady=10)
        ttk.Button(btn_frame, text="åˆ†äº«åˆ°ç¤¾åŒº", command=self.share_from_analysis, width=15).pack(side=tk.LEFT, padx=5)
        ttk.Button(btn_frame, text="ä¿å­˜ç»“æœ", command=self.save_result, width=15).pack(side=tk.LEFT, padx=5)
        ttk.Button(btn_frame, text="è¿”å›ä¸»é¡µé¢", command=self.show_main_page, width=15).pack(side=tk.LEFT, padx=5)

    def setup_image_preview(self, parent):
        """è®¾ç½®å›¾ç‰‡é¢„è§ˆåŒºåŸŸ"""
        image_frame = ttk.LabelFrame(parent, text="é¢˜ç›®å›¾ç‰‡é¢„è§ˆ")
        image_frame.pack(fill=tk.BOTH, expand=True, padx=5, pady=5)

        self.canvas = tk.Canvas(image_frame, bg="white", width=300, height=400)
        self.canvas.pack(fill=tk.BOTH, expand=True, padx=5, pady=5)
        self.canvas.create_text(150, 200, text="è¯·é€‰æ‹©é¢˜ç›®å›¾ç‰‡", font=("Arial", 14), fill="gray")

    def select_file(self):
        """é€‰æ‹©å›¾ç‰‡æ–‡ä»¶å¹¶é¢„è§ˆ"""
        file_path = filedialog.askopenfilename(
            filetypes=[("å›¾ç‰‡æ–‡ä»¶", "*.png;*.jpg;*.jpeg")]
        )
        if file_path:
            self.file_path.set(file_path)
            self.display_image(file_path)

    def display_image(self, image_path):
        """åœ¨ç”»å¸ƒä¸Šæ˜¾ç¤ºé€‰æ‹©çš„å›¾ç‰‡"""
        try:
            self.canvas.delete("all")
            img = Image.open(image_path)
            img_width, img_height = img.size
            canvas_width = self.canvas.winfo_width() or 300
            canvas_height = self.canvas.winfo_height() or 400

            # è®¡ç®—ç¼©æ”¾æ¯”ä¾‹
            scale = min(canvas_width / img_width, canvas_height / img_height)
            new_width = int(img_width * scale)
            new_height = int(img_height * scale)

            # ç¼©æ”¾å›¾ç‰‡
            img = img.resize((new_width, new_height), Image.LANCZOS)
            self.photo_img = ImageTk.PhotoImage(img)

            # åœ¨ç”»å¸ƒä¸Šæ˜¾ç¤ºå›¾ç‰‡
            self.canvas.create_image(
                canvas_width // 2,
                canvas_height // 2,
                anchor=tk.CENTER,
                image=self.photo_img
            )
        except Exception as e:
            log_error(f"å›¾ç‰‡æ˜¾ç¤ºå¼‚å¸¸: {str(e)}")
            self.canvas.create_text(150, 200, text="å›¾ç‰‡åŠ è½½å¤±è´¥", font=("Arial", 14), fill="red")

    def analyze_exercise(self):
        """åˆ†æé”™é¢˜"""
        file_path = self.file_path.get()
        if not file_path:
            messagebox.showerror("é”™è¯¯", "è¯·å…ˆé€‰æ‹©é”™é¢˜å›¾ç‰‡")
            return

        self.result_text.delete(1.0, tk.END)
        self.result_text.insert(tk.END, "æ­£åœ¨åˆ†æä¸­ï¼Œè¯·ç¨å€™...\n")
        self.root.update()

        threading.Thread(target=self.run_async_analysis, args=(file_path,)).start()

    def run_async_analysis(self, file_path):
        """å¼‚æ­¥è¿è¡Œåˆ†æä»»åŠ¡"""
        loop = asyncio.new_event_loop()
        asyncio.set_event_loop(loop)
        try:
            result = loop.run_until_complete(self.async_analyze_exercise(file_path))
            self.result_text.delete(1.0, tk.END)
            self.result_text.insert(tk.END, result)
        except Exception as e:
            self.result_text.delete(1.0, tk.END)
            self.result_text.insert(tk.END, f"åˆ†æå¤±è´¥: {str(e)}")
        finally:
            loop.close()

    async def async_analyze_exercise(self, file_path):
        """å¼‚æ­¥åˆ†æé”™é¢˜"""
        md_content = await image_to_markdown(file_path)
        if not md_content:
            return "å›¾ç‰‡è¯†åˆ«å¤±è´¥ï¼Œè¯·é‡è¯•æˆ–æ£€æŸ¥APIå¯†é’¥"

        prompt = f"è¿™æ˜¯ä¸€é“é”™é¢˜ï¼Œè¯·åˆ†æé”™è¯¯åŸå› å¹¶æä¾›æ­£ç¡®è§£æ³•ï¼š\n{md_content}"
        answers = await generate_answers(prompt)
        return answers if answers else "ç­”æ¡ˆç”Ÿæˆå¤±è´¥ï¼Œè¯·é‡è¯•æˆ–æ£€æŸ¥APIå¯†é’¥"

    def save_result(self):
        """ä¿å­˜åˆ†æç»“æœåˆ°æ–‡ä»¶"""
        content = self.resultæç®€.get("1.0", tk.END)
        if not content.strip():
            messagebox.showwarning("è­¦å‘Š", "æ²¡æœ‰å†…å®¹å¯ä¿å­˜")
            return

        # ç”Ÿæˆæ—¶é—´æˆ³æ–‡ä»¶å
        timestamp = datetime.datetime.now().strftime("%Y%m%d_%H%M%S")
        filename = f"analysis_{timestamp}.md"
        filepath = os.path.join("output", filename)

        try:
            os.makedirs("output", exist_ok=True)
            with open(filepath, "w", encoding="utf-8") as f:
                f.write(content)
            messagebox.showinfo("æˆåŠŸ", f"ç»“æœå·²ä¿å­˜åˆ°:\n{filepath}")
        except Exception as e:
            messagebox.showerror("é”™è¯¯", f"ä¿å­˜å¤±è´¥: {str(e)}")

    def share_from_analysis(self):
        """ä»åˆ†æé¡µé¢åˆ†äº«é¢˜ç›®åˆ°ç¤¾åŒº"""
        if not self.current_user:
            messagebox.showerror("é”™è¯¯", "è¯·å…ˆç™»å½•")
            return

        content = self.result_text.get("1.0", tk.END).strip()

        if not content:
            messagebox.showwarning("è­¦å‘Š", "æ²¡æœ‰å†…å®¹å¯åˆ†äº«")
            return

        self.share_question(content)

    # ===== æ–‡ä»¶ç®¡ç†åŠŸèƒ½ =====
    def show_file_manager(self):
        """æ˜¾ç¤ºæ–‡ä»¶ç®¡ç†é¡µé¢"""
        self.clear_frame()
        ttk.Label(self.main_frame, text="æ–‡ä»¶ç®¡ç†", font=("Arial", 16)).pack(pady=20)

        # æ–‡ä»¶å¤¹ç®¡ç†é€‰é¡¹
        ttk.Button(self.main_frame, text="æ¸…ç©ºå›¾ç‰‡æ–‡ä»¶å¤¹", command=lambda: self.clear_folder("images"), width=20).pack(
            pady=10)
        ttk.Button(self.main_frame, text="æ¸…ç©ºè¾“å‡ºæ–‡ä»¶å¤¹", command=lambda: self.clear_folder("output"), width=20).pack(
            pady=10)
        ttk.Button(self.main_frame, text="åˆå¹¶Markdownæ–‡ä»¶", command=self.run_merge_md_files, width=20).pack(pady=10)

        # æ‰“å¼€æ–‡ä»¶å¤¹æŒ‰é’®
        ttk.Button(self.main_frame, text="æ‰“å¼€å›¾ç‰‡æ–‡ä»¶å¤¹", command=lambda: self.open_folder("images"), width=20).pack(
            pady=10)
        ttk.Button(self.main_frame, text="æ‰“å¼€è¾“å‡ºæ–‡ä»¶å¤¹", command=lambda: self.open_folder("output"), width=20).pack(
            pady=10)

        # è¿”å›æŒ‰é’®
        ttk.Button(self.main_frame, text="è¿”å›ä¸»é¡µé¢", command=self.show_main_page, width=20).pack(pady=10)

    def clear_folder(self, folder_name):
        """æ¸…ç©ºæŒ‡å®šæ–‡ä»¶å¤¹"""
        if messagebox.askyesno("ç¡®è®¤", f"ç¡®å®šè¦æ¸…ç©º {folder_name} æ–‡ä»¶å¤¹å—ï¼Ÿ"):
            clear_folder(folder_name)
            messagebox.showinfo("å®Œæˆ", f"{folder_name} æ–‡ä»¶å¤¹å·²æ¸…ç©º")

    def run_merge_md_files(self):
        """è¿è¡Œåˆå¹¶Markdownæ–‡ä»¶æ“ä½œ"""
        if merge_md_files():
            messagebox.showinfo("æˆåŠŸ", "Markdownæ–‡ä»¶åˆå¹¶å®Œæˆï¼")
        else:
            messagebox.showwarning("è­¦å‘Š", "æ²¡æœ‰æ‰¾åˆ°å¯åˆå¹¶çš„Markdownæ–‡ä»¶")

    def open_folder(self, folder_name):
        """æ‰“å¼€æŒ‡å®šæ–‡ä»¶å¤¹"""
        folder_path = os.path.abspath(folder_name)

        if not os.path.exists(folder_path):
            os.makedirs(folder_path, exist_ok=True)

        try:
            if platform.system() == "Windows":
                os.startfile(folder_path)
            elif platform.system() == "Darwin":  # macOS
                subprocess.Popen(["open", folder_path])
            else:  # Linux
                subprocess.Popen(["xdg-open", folder_path])
        except Exception as e:
            messagebox.showerror("é”™è¯¯", f"æ— æ³•æ‰“å¼€æ–‡ä»¶å¤¹: {str(e)}")

    # ===== è´¦å·ç®¡ç†åŠŸèƒ½ =====
    def show_account_settings(self):
        """æ˜¾ç¤ºè´¦å·è®¾ç½®é¡µé¢"""
        self.clear_frame()
        ttk.Label(self.main_frame, text="è´¦å·è®¾ç½®", font=("Arial", 16)).pack(pady=20)
        ttk.Button(self.main_frame, text="ä¿®æ”¹å¯†ç ", command=self.show_change_password, width=20).pack(pady=10)
        ttk.Button(self.main_frame, text="è´¦æˆ·æ³¨é”€", command=self.show_delete_account, width=20).pack(pady=10)
        ttk.Button(self.main_frame, text="è¿”å›ä¸»é¡µé¢", command=self.show_main_page, width=20).pack(pady=10)

    def show_change_password(self):
        """æ˜¾ç¤ºä¿®æ”¹å¯†ç è¡¨å•"""
        self.clear_frame()
        ttk.Label(self.main_frame, text="ä¿®æ”¹å¯†ç ", font=("Arial", 16)).pack(pady=20)

        # åŸå¯†ç è¾“å…¥
        ttk.Label(self.main_frame, text="åŸå¯†ç :").pack()
        self.old_password = ttk.Entry(self.main_frame, show="*", width=30)
        self.old_password.pack(pady=5)

        # æ–°å¯†ç è¾“å…¥
        ttk.Label(self.main_frame, text="æ–°å¯†ç :").pack()
        self.new_password = ttk.Entry(self.main_frame, show="*", width=30)
        self.new_password.pack(pady=5)

        # ç¡®è®¤æ–°å¯†ç è¾“å…¥
        ttk.Label(self.main_frame, text="ç¡®è®¤æ–°å¯†ç :").pack()
        self.confirm_password = ttk.Entry(self.main_frame, show="*", width=30)
        self.confirm_password.pack(pady=5)

        # æŒ‰é’®åŒºåŸŸ
        btn_frame = ttk.Frame(self.main_frame)
        btn_frame.pack(pady=20)
        ttk.Button(btn_frame, text="ç¡®è®¤ä¿®æ”¹", command=self.change_password).pack(side=tk.LEFT, padx=10)
        ttk.Button(btn_frame, text="è¿”å›", command=self.show_account_settings).pack(side=tk.LEFT, padx=10)

    def change_password(self):
        """å¤„ç†å¯†ç ä¿®æ”¹é€»è¾‘"""
        old_pwd = self.old_password.get()
        new_pwd = self.new_password.get()
        confirm_pwd = self.confirm_password.get()

        if not all([old_pwd, new_pwd, confirm_pwd]):
            messagebox.showerror("é”™è¯¯", "æ‰€æœ‰å­—æ®µéƒ½å¿…é¡»å¡«å†™")
            return

        if new_pwd != confirm_pwd:
            messagebox.showerror("é”™è¯¯", "ä¸¤æ¬¡è¾“å…¥çš„æ–°å¯†ç ä¸ä¸€è‡´")
            return

        if len(new_pwd) < 6:
            messagebox.showerror("é”™è¯¯", "æ–°å¯†ç é•¿åº¦è‡³å°‘ä¸º6æç®€")
            return

        hashed_old = hash_password(old_pwd)
        hashed_new = hash_password(new_pwd)

        try:
            conn = sqlite3.connect('user_db.db')
            c = conn.cursor()
            c.execute("SELECT * FROM users WHERE id=? AND password=?", (self.current_user, hashed_old))
            if not c.fetchone():
                messagebox.showerror("é”™è¯¯", "åŸå¯†ç ä¸æ­£ç¡®")
                return

            c.execute("UPDATE users SET password=? WHERE id=?", (hashed_new, self.current_user))
            conn.commit()
            messagebox.showinfo("æˆåŠŸ", "å¯†ç ä¿®æ”¹æˆåŠŸï¼")
            self.show_account_settings()
        except Exception as e:
            messagebox.showerror("é”™è¯¯", f"å¯†ç ä¿®æ”¹å¤±è´¥: {str(e)}")
        finally:
            conn.close()

    def show_delete_account(self):
        """æ˜¾ç¤ºè´¦æˆ·æ³¨é”€é¡µé¢"""
        self.clear_frame()
        ttk.Label(self.main_frame, text="è´¦æˆ·æ³¨é”€", font=("Arial", 16)).pack(pady=20)
        ttk.Label(self.main_frame, text="æ­¤æ“ä½œå°†æ°¸ä¹…åˆ é™¤æ‚¨çš„è´¦æˆ·ï¼", foreground="red").pack()

        # å¯†ç ç¡®è®¤è¾“å…¥
        ttk.Label(self.main_frame, text="è¯·è¾“å…¥å¯†ç ç¡®è®¤:").pack(pady=10)
        self.delete_password = ttk.Entry(self.main_frame, show="*", width=30)
        self.delete_password.pack(pady=5)

        # æŒ‰é’®åŒºåŸŸ
        btn_frame = ttk.Frame(self.main_frame)
        btn_frame.pack(pady=20)
        ttk.Button(btn_frame, text="ç¡®è®¤æ³¨é”€", command=self.delete_account).pack(side=tk.LEFT, padx=10)
        ttk.Button(btn_frame, text="è¿”å›", command=self.show_account_settings).pack(side=tk.LEFT, padx=10)

    def delete_account(self):
        """å¤„ç†è´¦æˆ·æ³¨é”€é€»è¾‘"""
        password = self.delete_password.get()
        if not password:
            messagebox.showerror("é”™è¯¯", "è¯·è¾“å…¥å¯†ç ")
            return

        hashed_pwd = hash_password(password)
        try:
            conn = sqlite3.connect('user_db.db')
            c = conn.cursor()
            c.execute("SELECT * FROM users WHERE id=? AND password=?", (self.current_user, hashed_pwd))
            if not c.fetchone():
                messagebox.showerror("é”™è¯¯", "å¯†ç ä¸æ­£ç¡®")
                return

            c.execute("DELETE FROM users WHERE id=?", (self.current_user,))
            conn.commit()
            messagebox.showinfo("æˆåŠŸ", "è´¦æˆ·å·²æˆåŠŸæ³¨é”€")
            self.logout()
        except Exception as e:
            messagebox.showerror("é”™è¯¯", f"è´¦æˆ·æ³¨é”€å¤±è´¥: {str(e)}")
        finally:
            conn.close()

    # ===== ç¤¾åŒºåŠŸèƒ½ =====
    def show_community_page(self):
        """æ˜¾ç¤ºé¢˜ç›®åˆ†äº«ç¤¾åŒºé¡µé¢"""
        self.clear_frame()

        # æ·»åŠ é¡¶éƒ¨è¿”å›æŒ‰é’®
        top_frame = ttk.Frame(self.main_frame)
        top_frame.pack(fill=tk.X, padx=10, pady=5)
        ttk.Button(top_frame, text="â† è¿”å›ä¸»é¡µé¢", command=self.show_main_page).pack(side=tk.LEFT)

        ttk.Label(self.main_frame, text="é¢˜ç›®åˆ†äº«ç¤¾åŒº", font=("Arial", 16)).pack(pady=10)

        # åŠŸèƒ½æŒ‰é’®åŒº
        btn_frame = ttk.Frame(self.main_frame)
        btn_frame.pack(fill=tk.X, padx=20, pady=10)

        ttk.Button(btn_frame, text="åˆ†äº«é¢˜ç›®", command=lambda: self.share_question(None)).pack(side=tk.LEFT)
        ttk.Button(btn_frame, text="æˆ‘çš„åˆ†äº«", command=self.show_my_shared).pack(side=tk.LEFT, padx=10)
        ttk.Button(btn_frame, text="çƒ­é—¨é¢˜ç›®", command=self.show_hot_questions).pack(side=tk.LEFT)

        # æœç´¢åŒº
        search_frame = ttk.Frame(self.main_frame)
        search_frame.pack(fill=tk.X, padx=20, pady=5)

        ttk.Label(search_frame, text="æœç´¢:").pack(side=tk.LEFT)
        self.search_entry = ttk.Entry(search_frame, width=30)
        self.search_entry.pack(side=tk.LEFT, padx=5)
        ttk.Button(search_frame, text="æœç´¢", command=self.search_questions).pack(side=tk.LEFT)

        # é¢˜ç›®åˆ—è¡¨
        list_frame = ttk.LabelFrame(self.main_frame, text="æœ€æ–°é¢˜ç›®")
        list_frame.pack(fill=tk.BOTH, expand=True, padx=20, pady=10)

        # ä½¿ç”¨Treeviewæ˜¾ç¤ºé¢˜ç›®åˆ—è¡¨
        columns = ("id", "title", "author", "likes", "date")
        self.question_tree = ttk.Treeview(
            list_frame,
            columns=columns,
            show="headings"
        )

        # è®¾ç½®åˆ—å®½å’Œæ ‡é¢˜
        self.question_tree.column("id", width=50, anchor="center")
        self.question_tree.heading("id", text="ID")
        self.question_tree.column("title", width=200)
        self.question_tree.heading("title", text="æ ‡é¢˜")
        self.question_tree.column("author", width=80)
        self.question_tree.heading("author", text="ä½œè€…")
        self.question_tree.column("likes", width=50)
        self.question_tree.heading("likes", text="ç‚¹èµ")
        self.question_tree.column("date", width=80)
        self.question_tree.heading("date", text="æ—¥æœŸ")

        # æ·»åŠ æ»šåŠ¨æ¡
        scrollbar = ttk.Scrollbar(list_frame, orient="vertical", command=self.question_tree.yview)
        self.question_tree.configure(yscrollcommand=scrollbar.set)
        scrollbar.pack(side="right", fill="y")
        self.question_tree.pack(fill="both", expand=True)

        # ç»‘å®šé€‰æ‹©äº‹ä»¶
        self.question_tree.bind("<<TreeviewSelect>>", self.show_question_detail)

        # åŠ è½½é¢˜ç›®æ•°æ®
        self.load_community_questions()

    def load_community_questions(self):
        """åŠ è½½ç¤¾åŒºé¢˜ç›®"""
        try:
            # æ¸…ç©ºç°æœ‰æ•°æ®
            for item in self.question_tree.get_children():
                self.question_tree.delete(item)

            # ä»æ•°æ®åº“è·å–æ•°æ®
            conn = sqlite3.connect('user_db.db')
            c = conn.cursor()
            c.execute("""
                SELECT sq.id, sq.title, 
                       CASE WHEN sq.user_id = 0 THEN 'ç³»ç»Ÿ' ELSE u.username END as author, 
                       sq.likes, sq.created_at
                FROM shared_questions sq
                LEFT JOIN users u ON sq.user_id = u.id
                ORDER BY sq.created_at DESC
                LIMIT 50
            """)
            questions = c.fetchall()

            # æ·»åŠ åˆ°åˆ—è¡¨
            for q in questions:
                # æ ¼å¼åŒ–æ—¥æœŸ
                created_at = q[4].split()[0] if isinstance(q[4], str) else q[4]
                self.question_tree.insert("", "end", values=(q[0], q[1], q[2], q[3], created_at))

            conn.close()
        except Exception as e:
            log_error(f"åŠ è½½é¢˜ç›®å¤±è´¥: {str(e)}")
            messagebox.showerror("é”™è¯¯", f"åŠ è½½é¢˜ç›®å¤±è´¥: {str(e)}")

    def share_question(self, content=None):
        """åˆ†äº«é¢˜ç›®"""
        if not self.current_user:
            messagebox.showerror("é”™è¯¯", "è¯·å…ˆç™»å½•")
            return

        # åˆ›å»ºåˆ†äº«çª—å£
        share_win = tk.Toplevel(self.root)
        share_win.title("åˆ†äº«é¢˜ç›®")
        share_win.geometry("600x500")

        # æ ‡é¢˜è¾“å…¥
        ttk.Label(share_win, text="é¢˜ç›®æ ‡é¢˜:").pack(pady=(10, 5))
        title_entry = ttk.Entry(share_win, width=50)
        title_entry.pack(pady=5)

        # å†…å®¹è¾“å…¥
        ttk.Label(share_win, text="é¢˜ç›®å†…å®¹ (Markdownæ ¼å¼):").pack(pady=(10, 5))
        content_text = tk.Text(share_win, wrap="word", height=10)
        scrollbar = ttk.Scrollbar(share_win, command=content_text.yview)
        content_text.configure(yscrollcommand=scrollbar.set)
        scrollbar.pack(side="right", fill="y")
        content_text.pack(fill="both", expand=True, padx=10, pady=5)

        # å¦‚æœä»åˆ†æé¡µé¢ä¼ å…¥å†…å®¹ï¼Œåˆ™å¡«å……
        if content:
            content_text.insert(tk.END, content)

        # æ ‡ç­¾è¾“å…¥
        ttk.Label(share_win, text="æ ‡ç­¾ (é€—å·åˆ†éš”):").pack(pady=(10, 5))
        tags_entry = ttk.Entry(share_win, width=50)
        tags_entry.pack(pady=5)

        def submit_question():
            """æäº¤é¢˜ç›®åˆ†äº«"""
            title = title_entry.get().strip()
            content = content_text.get("1.0", tk.END).strip()
            tags = tags_entry.get().strip()

            if not title:
                messagebox.showerror("é”™è¯¯", "æ ‡é¢˜ä¸èƒ½ä¸ºç©º")
                return

            if not content:
                messagebox.showerror("é”™è¯¯", "å†…å®¹ä¸èƒ½ä¸ºç©º")
                return

            try:
                conn = sqlite3.connect('user_db.db')
                c = conn.cursor()
                c.execute("""
                    INSERT INTO shared_questions (user_id, title, content, tags)
                    VALUES (?, ?, ?, ?)
                """, (self.current_user, title, content, tags))
                conn.commit()
                conn.close()
                messagebox.showinfo("æˆåŠŸ", "é¢˜ç›®åˆ†äº«æˆåŠŸï¼")
                share_win.destroy()
                self.load_community_questions()  # åˆ·æ–°åˆ—è¡¨
            except Exception as e:
                messagebox.showerror("é”™è¯¯", f"åˆ†äº«å¤±è´¥: {str(e)}")

        # æäº¤æŒ‰é’®
        btn_frame = ttk.Frame(share_win)
        btn_frame.pack(pady=10)
        ttk.Button(btn_frame, text="æäº¤", command=submit_question).pack(side=tk.LEFT, padx=10)
        ttk.Button(btn_frame, text="å–æ¶ˆ", command=share_win.destroy).pack(side=tk.LEFT, padx=10)

    def show_my_shared(self):
        """æ˜¾ç¤ºæˆ‘åˆ†äº«çš„é¢˜ç›®"""
        if not self.current_user:
            messagebox.showerror("é”™è¯¯", "è¯·å…ˆç™»å½•")
            return

        # æ¸…ç©ºç°æœ‰æ•°æ®
        for item in self.question_tree.get_children():
            self.question_tree.delete(item)

        try:
            # ä»æ•°æ®åº“è·å–æ•°æ®
            conn = sqlite3.connect('user_db.db')
            c = conn.cursor()
            c.execute("""
                SELECT id, title, created_at, likes
                FROM shared_questions
                WHERE user_id = ?
                ORDER BY created_at DESC
            """, (self.current_user,))
            questions = c.fetchall()

            # æ·»åŠ åˆ°åˆ—è¡¨
            for q in questions:
                # æ ¼å¼åŒ–æ—¥æœŸ
                created_at = q[2].split()[0] if isinstance(q[2], str) else q[2]
                self.question_tree.insert("", "end", values=(q[0], q[1], self.get_username(), q[3], created_at))

            conn.close()
            messagebox.showinfo("æç¤º", f"å·²æ˜¾ç¤ºæ‚¨åˆ†äº«çš„ {len(questions)} ä¸ªé¢˜ç›®")
        except Exception as e:
            log_error(f"åŠ è½½é¢˜ç›®å¤±è´¥: {str(e)}")
            messagebox.showerror("é”™è¯¯", f"åŠ è½½é¢˜ç›®å¤±è´¥: {str(e)}")

    def show_hot_questions(self):
        """æ˜¾ç¤ºçƒ­é—¨é¢˜ç›®"""
        # æ¸…ç©ºç°æœ‰æ•°æ®
        for item in self.question_tree.get_children():
            self.question_tree.delete(item)

        try:
            # ä»æ•°æ®åº“è·å–æ•°æ®
            conn = sqlite3.connect('user_db.db')
            c = conn.cursor()
            c.execute("""
                SELECT sq.id, sq.title, 
                       CASE WHEN sq.user_id = 0 THEN 'ç³»ç»Ÿ' ELSE u.username END as author, 
                       sq.likes, sq.created_at
                FROM shared_questions sq
                LEFT JOIN users u ON sq.user_id = u.id
                ORDER BY sq.likes DESC, sq.created_at DESC
                LIMIT 20
            """)
            questions = c.fetchall()

            # æ·»åŠ åˆ°åˆ—è¡¨
            for q in questions:
                # æ ¼å¼åŒ–æ—¥æœŸ
                created_at = q[4].split()[0] if isinstance(q[4], str) else q[4]
                self.question_tree.insert("", "end", values=(q[0], q[1], q[2], q[3], created_at))

            conn.close()
            messagebox.showinfo("æç¤º", f"å·²æ˜¾ç¤º {len(questions)} ä¸ªçƒ­é—¨é¢˜ç›®")
        except Exception as e:
            log_error(f"åŠ è½½é¢˜ç›®å¤±è´¥: {str(e)}")
            messagebox.showerror("é”™è¯¯", f"åŠ è½½é¢˜ç›®å¤±è´¥: {str(e)}")

    def search_questions(self):
        """æœç´¢é¢˜ç›®"""
        keyword = self.search_entry.get().strip()
        if not keyword:
            messagebox.showwarning("æç¤º", "è¯·è¾“å…¥æœç´¢å…³é”®è¯")
            return

        # æ¸…ç©ºç°æœ‰æ•°æ®
        for item in self.question_tree.get_children():
            self.question_tree.delete(item)

        try:
            # ä»æ•°æ®åº“è·å–æ•°æ®
            conn = sqlite3.connect('user_db.db')
            c = conn.cursor()
            c.execute("""
                SELECT sq.id, sq.title, 
                       CASE WHEN sq.user_id = 0 THEN 'ç³»ç»Ÿ' ELSE u.username END as author, 
                       sq.likes, sq.created_at
                FROM shared_questions sq
                LEFT JOIN users u ON sq.user_id = u.id
                WHERE sq.title LIKE ? OR sq.content LIKE ? OR sq.tags LIKE ?
                ORDER BY sq.created_at DESC
            """, (f"%{keyword}%", f"%{keyword}%", f"%{keyword}%"))
            questions = c.fetchall()

            # æ·»åŠ åˆ°åˆ—è¡¨
            for q in questions:
                # æ ¼å¼åŒ–æ—¥æœŸ
                created_at = q[4].split()[0] if isinstance(q[4], str) else q[4]
                self.question_tree.insert("", "end", values=(q[0], q[1], q[2], q[3], created_at))

            conn.close()
            messagebox.showinfo("æç¤º", f"æ‰¾åˆ° {len(questions)} ä¸ªç›¸å…³é¢˜ç›®")
        except Exception as e:
            log_error(f"æœç´¢å¤±è´¥: {str(e)}")
            messagebox.showerror("é”™è¯¯", f"æœç´¢å¤±è´¥: {str(e)}")

    def show_question_detail(self, event):
        """æ˜¾ç¤ºé¢˜ç›®è¯¦æƒ…"""
        selected = self.question_tree.focus()
        if not selected:
            return

        values = self.question_tree.item(selected, "values")
        if not values:
            return

        question_id = values[0]

        # ä»æ•°æ®åº“è·å–é¢˜ç›®è¯¦æƒ…
        try:
            conn = sqlite3.connect('user_db.db')
            c = conn.cursor()
            c.execute("""
                SELECT sq.title, sq.content, 
                       CASE WHEN sq.user_id = 0 THEN 'ç³»ç»Ÿ' ELSE u.username END as author, 
                       sq.created_at
                FROM shared_questions sq
                LEFT JOIN users u ON sq.user_id = u.id
                WHERE sq.id = ?
            """, (question_id,))
            question = c.fetchone()
            conn.close()

            if not question:
                messagebox.showerror("é”™è¯¯", "é¢˜ç›®ä¸å­˜åœ¨")
                return
        except Exception as e:
            messagebox.showerror("é”™è¯¯", f"åŠ è½½é¢˜ç›®å¤±è´¥: {str(e)}")
            return

        # åˆ›å»ºè¯¦æƒ…çª—å£
        detail_win = tk.Toplevel(self.root)
        detail_win.title(f"é¢˜ç›®è¯¦æƒ… - {question[0]}")
        detail_win.geometry("900x700")

        # ä½¿ç”¨Notebookåˆ†æ ‡ç­¾é¡µ
        notebook = ttk.Notebook(detail_win)
        notebook.pack(fill="both", expand=True)

        # å†…å®¹æ ‡ç­¾é¡µ
        content_frame = ttk.Frame(notebook)
        notebook.add(content_frame, text="é¢˜ç›®å†…å®¹")

        # ä½¿ç”¨Textç»„ä»¶æ˜¾ç¤ºå†…å®¹
        ttk.Label(content_frame, text="é¢˜ç›®åˆ†æ:").pack(pady=(10, 5))
        content_text = tk.Text(content_frame, wrap="word", height=15)
        scrollbar = ttk.Scrollbar(content_frame, command=content_text.yview)
        content_text.configure(yscrollcommand=scrollbar.set)
        scrollbar.pack(side="right", fill="y")
        content_text.pack(fill="both", expand=True, padx=10, pady=5)
        content_text.insert("end", question[1] if question[1] else "æš‚æ— è¯¦ç»†å†…å®¹")
        content_text.config(state=tk.DISABLED)  # è®¾ç½®ä¸ºåªè¯»

        # è¯„è®ºæ ‡ç­¾é¡µ
        comment_frame = ttk.Frame(notebook)
        notebook.add(comment_frame, text=f"è¯„è®º")

        # æ·»åŠ è¯„è®ºåŠŸèƒ½
        comment_entry = tk.Text(comment_frame, height=5)
        comment_entry.pack(fill="x", padx=10, pady=10)

        def submit_comment():
            """æäº¤è¯„è®º"""
            content = comment_entry.get("1.0", "end").strip()
            if not content:
                messagebox.showwarning("æç¤º", "è¯„è®ºå†…å®¹ä¸èƒ½ä¸ºç©º")
                return

            try:
                conn = sqlite3.connect('user_db.db')
                c = conn.cursor()
                c.execute("""
                    INSERT INTO comments (question_id, user_id, content)
                    VALUES (?, ?, ?)
                """, (question_id, self.current_user, content))
                conn.commit()
                conn.close()
                messagebox.showinfo("æˆåŠŸ", "è¯„è®ºå·²æäº¤")
                comment_entry.delete("1.0", tk.END)  # æ¸…ç©ºè¯„è®ºæ¡†
            except Exception as e:
                messagebox.showerror("é”™è¯¯", f"æäº¤è¯„è®ºå¤±è´¥: {str(e)}")

        ttk.Button(comment_frame, text="æäº¤è¯„è®º", command=submit_comment).pack(pady=5)

        # äº’åŠ¨åŠŸèƒ½
        action_frame = ttk.Frame(detail_win)
        action_frame.pack(fill="x", padx=10, pady=5)

        # ç‚¹èµåŠŸèƒ½
        like_btn = ttk.Button(action_frame, text="ğŸ‘ ç‚¹èµ",
                              command=lambda: self.like_question(question_id))
        like_btn.pack(side="left", padx=5)

        # æ”¶è—åŠŸèƒ½
        fav_btn = ttk.Button(action_frame, text="â­ æ”¶è—",
                             command=lambda: self.favorite_question(question_id))
        fav_btn.pack(side="left", padx=5)

        # å…³é—­æŒ‰é’®
        ttk.Button(action_frame, text="å…³é—­", command=detail_win.destroy).pack(side="right", padx=5)

    def like_question(self, question_id):
        """ç‚¹èµé¢˜ç›®"""
        try:
            conn = sqlite3.connect('user_db.db')
            c = conn.cursor()
            c.execute("""
                UPDATE shared_questions 
                SET likes = likes + 1 
                WHERE id = ?
            """, (question_id,))
            conn.commit()
            conn.close()
            messagebox.showinfo("æˆåŠŸ", "å·²ç‚¹èµ")
        except Exception as e:
            messagebox.showerror("é”™è¯¯", f"ç‚¹èµå¤±è´¥: {str(e)}")

    def favorite_question(self, question_id):
        """æ”¶è—é¢˜ç›®"""
        messagebox.showinfo("æç¤º", "æ”¶è—åŠŸèƒ½å·²è®°å½•")


# ===== ä¸»ç¨‹åºå…¥å£ =====
if __name__ == "__main__":
    # åˆ›å»ºå¿…è¦æ–‡ä»¶å¤¹
    for folder in ["images", "output"]:
        os.makedirs(folder, exist_ok=True)

    root = tk.Tk()
    style = ttk.Style()
    style.configure("TButton", padding=6, relief="flat", background="#ccc")
    app = ExamHelperApp(root)
    root.mainloop()
